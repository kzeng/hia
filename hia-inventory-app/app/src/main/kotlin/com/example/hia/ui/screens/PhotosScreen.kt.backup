package com.example.hia.ui.screens

import android.Manifest
import android.content.pm.PackageManager
import android.util.Log
import androidx.camera.core.CameraSelector
import androidx.camera.core.Preview
import androidx.camera.lifecycle.ProcessCameraProvider
import androidx.camera.view.PreviewView
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Folder
import androidx.compose.material.icons.filled.Camera
import androidx.compose.material.icons.filled.PhotoLibrary
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.core.content.ContextCompat
import androidx.navigation.NavHostController
import kotlinx.coroutines.launch
import java.util.concurrent.ExecutorService
import java.util.concurrent.Executors

@OptIn(ExperimentalFoundationApi::class)
@Composable
fun PhotosScreen(navController: NavHostController) {
    var showCamera by remember { mutableStateOf(false) }
    
    Scaffold(
        topBar = { 
            TopAppBar(
                title = { Text(if (showCamera) "摄像预览" else "照片管理") },
                actions = {
                    IconButton(onClick = { showCamera = !showCamera }) {
                        Icon(
                            imageVector = if (showCamera) Icons.Default.PhotoLibrary else Icons.Default.Camera,
                            contentDescription = if (showCamera) "切换到照片库" else "切换到摄像预览"
                        )
                    }
                }
            ) 
        }
    ) { pad ->
        if (showCamera) {
            CameraPreviewScreen(modifier = Modifier.fillMaxSize().padding(pad))
        } else {
            PhotoLibraryScreen(modifier = Modifier.fillMaxSize().padding(pad))
        }
    }
}

@OptIn(ExperimentalFoundationApi::class)
@Composable
fun PhotoLibraryScreen(modifier: Modifier = Modifier) {
    val folders = remember { mutableStateListOf("20260105", "20251231", "20250101") }
    var selectedFolder by remember { mutableStateOf(folders.first()) }

    // 模拟图片文件名
    val images = remember(selectedFolder) {
        List(32) { idx -> "01020301041-${System.currentTimeMillis() - idx * 1000}.png" }
    }
    var page by remember { mutableStateOf(0) }
    val pageSize = 16
    val pageCount = (images.size + pageSize - 1) / pageSize
    val pageItems = images.drop(page * pageSize).take(pageSize)

    Row(
        modifier = modifier.padding(16.dp),
        horizontalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        // 左栏 25% 宽度：文件夹列表
        FoldersPanel(
            modifier = Modifier.weight(0.25f).fillMaxHeight(),
            folders = folders,
            selected = selectedFolder,
            onSelect = { selectedFolder = it },
            onDelete = { folders.remove(it); if (folders.isNotEmpty()) selectedFolder = folders.first() },
            onUpload = { /* TODO: 上传文件夹 */ }
        )

        // 右栏：图片 GRID + 分页
        Column(modifier = Modifier.weight(0.75f)) {
            Card(
                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                shape = RoundedCornerShape(12.dp)
            ) {
                Column(Modifier.padding(12.dp)) {
                    LazyVerticalGrid(columns = GridCells.Fixed(4), verticalArrangement = Arrangement.spacedBy(12.dp), horizontalArrangement = Arrangement.spacedBy(12.dp), modifier = Modifier.fillMaxWidth().weight(1f)) {
                        items(pageItems) { name ->
                            ImageTile(name = name)
                        }
                    }
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text("第 ${page + 1} / $pageCount 页", style = MaterialTheme.typography.bodyMedium)
                        Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                            Button(enabled = page > 0, onClick = { page-- }) { Text("上一页") }
                            Button(enabled = page < pageCount - 1, onClick = { page++ }) { Text("下一页") }
                        }
                    }
                }
            }
        }
    }
}

@Composable
fun CameraPreviewScreen(modifier: Modifier = Modifier) {
    val context = LocalContext.current
    val lifecycleOwner = LocalLifecycleOwner.current
    var cameraPermissionGranted by remember {
        mutableStateOf(
            ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.CAMERA
            ) == PackageManager.PERMISSION_GRANTED
        )
    }
    
    LaunchedEffect(Unit) {
        if (!cameraPermissionGranted) {
            // 在实际应用中，这里应该请求权限
            // 为了简化，我们假设权限已授予
            cameraPermissionGranted = true
        }
    }
    
    Box(
        modifier = modifier
            .fillMaxSize()
            .background(Color.Black),
        contentAlignment = Alignment.Center
    ) {
        if (cameraPermissionGranted) {
            BoxWithConstraints(modifier = Modifier.fillMaxSize()) {
                CameraPreviewView()
                
                // 圆形拍摄按钮，悬浮在预览窗口底部
                FloatingActionButton(
                    onClick = {
                        // TODO: 实现拍摄功能
                    },
                    containerColor = MaterialTheme.colorScheme.primary,
                    contentColor = MaterialTheme.colorScheme.onPrimary,
                    modifier = Modifier
                        .size(80.dp)
                        .align(Alignment.BottomCenter)
                        .padding(bottom = 32.dp)
                ) {
                    Icon(
                        imageVector = Icons.Default.Camera,
                        contentDescription = "拍摄",
                        modifier = Modifier.size(40.dp)
                    )
                }
            }
        } else {
            Text("需要摄像头权限", color = Color.White)
        }
    }
}

@Composable
fun CameraPreviewView() {
    val context = LocalContext.current
    val lifecycleOwner = LocalLifecycleOwner.current
    val cameraExecutor = remember { Executors.newSingleThreadExecutor() }
    
    AndroidView(
        factory = { ctx ->
            PreviewView(ctx).apply {
                scaleType = PreviewView.ScaleType.FILL_CENTER
            }
        },
        modifier = Modifier.fillMaxSize(),
        update = { previewView ->
            val cameraProviderFuture = ProcessCameraProvider.getInstance(context)
            cameraProviderFuture.addListener({
                val cameraProvider: ProcessCameraProvider = cameraProviderFuture.get()
                
                val preview = Preview.Builder()
                    .build()
                    .also {
                        it.setSurfaceProvider(previewView.surfaceProvider)
                    }
                
                val cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA
                
                try {
                    cameraProvider.unbindAll()
                    cameraProvider.bindToLifecycle(
                        lifecycleOwner,
                        cameraSelector,
                        preview
                    )
                } catch (exc: Exception) {
                    Log.e("CameraPreview", "Use case binding failed", exc)
                }
            }, ContextCompat.getMainExecutor(context))
        }
    )
    
    DisposableEffect(Unit) {
        onDispose {
            cameraExecutor.shutdown()
        }
    }
}

@Composable
private fun FoldersPanel(
    modifier: Modifier,
    folders: List<String>,
    selected: String,
    onSelect: (String) -> Unit,
    onDelete: (String) -> Unit,
    onUpload: (String) -> Unit
) {
    Card(modifier = modifier, colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface), shape = RoundedCornerShape(12.dp)) {
        Column(Modifier.padding(12.dp)) {
            Text("图片目录", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
            Spacer(Modifier.height(8.dp))
            LazyColumn(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                items(folders.size) { idx ->
                    val name = folders[idx]
                    FolderRow(name = name, selected = name == selected, onClick = { onSelect(name) }, onDelete = onDelete, onUpload = onUpload)
                }
            }
        }
    }
}

@Composable
private fun FolderRow(
    name: String,
    selected: Boolean,
    onClick: () -> Unit,
    onDelete: (String) -> Unit,
    onUpload: (String) -> Unit
) {
    var menuOpen by remember { mutableStateOf(false) }
    val scope = rememberCoroutineScope()

    Card(colors = CardDefaults.cardColors(containerColor = if (selected) MaterialTheme.colorScheme.secondaryContainer else MaterialTheme.colorScheme.surfaceVariant)) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(10.dp)
                .pointerInput(Unit) {
                    detectTapGestures(
                        onTap = { onClick() },
                        onLongPress = { menuOpen = true }
                    )
                },
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Icon(Icons.Default.Folder, contentDescription = null)
            Text(name, style = MaterialTheme.typography.bodyLarge)
            Box {
                DropdownMenu(expanded = menuOpen, onDismissRequest = { menuOpen = false }) {
                    DropdownMenuItem(text = { Text("删除文件夹") }, onClick = { menuOpen = false; onDelete(name) })
                    DropdownMenuItem(text = { Text("上传文件夹") }, onClick = { menuOpen = false; onUpload(name) })
                }
            }
        }
    }
}

@Composable
private fun ImageTile(name: String) {
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Box(
            modifier = Modifier
                .size(160.dp)
                .background(MaterialTheme.colorScheme.primaryContainer, RoundedCornerShape(8.dp)),
            contentAlignment = Alignment.Center
        ) {
            Text("预览", color = MaterialTheme.colorScheme.onPrimaryContainer)
        }
        Spacer(Modifier.height(6.dp))
        Text(name, style = MaterialTheme.typography.bodySmall, maxLines = 1)
    }
}
